name: Vercel Domain Rotation Bot

on:
  schedule:
    # Runs 4 times daily: 12 AM, 6 AM, 12 PM, 6 PM (UTC+1)
    # Converted to UTC: 11 PM, 5 AM, 11 AM, 5 PM
    - cron: '0 23,5,11,17 * * *'
  
  workflow_dispatch:
    inputs:
      new_domain:
        description: 'Override NEW_DOMAIN (optional)'
        required: false
        type: string

env:
  NODE_VERSION: '20'

jobs:
  rotate-domain:
    name: Rotate Domain & Update Env
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Run Domain Rotation Bot
        env:
          PROJECT_A_TOKEN: ${{ secrets.PROJECT_A_TOKEN }}
          PROJECT_A_ID: ${{ secrets.PROJECT_A_ID }}
          PROJECT_A_TEAM_ID: ${{ secrets.PROJECT_A_TEAM_ID }}
          PROJECT_B_TOKEN: ${{ secrets.PROJECT_B_TOKEN }}
          PROJECT_B_ID: ${{ secrets.PROJECT_B_ID }}
          PROJECT_B_TEAM_ID: ${{ secrets.PROJECT_B_TEAM_ID }}
          PROJECT_B_DEPLOY_HOOK: ${{ secrets.PROJECT_B_DEPLOY_HOOK }}
          NEW_DOMAIN: ${{ github.event.inputs.new_domain || secrets.NEW_DOMAIN }}
          ENV_VAR_KEY: ${{ secrets.ENV_VAR_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          WEBHOOK_WAIT_SECONDS: ${{ secrets.WEBHOOK_WAIT_SECONDS }}
        run: |
          # Validate required secrets are set (without exposing values)
          if [ -z "$PROJECT_A_TOKEN" ]; then
            echo "::error::PROJECT_A_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$PROJECT_A_ID" ]; then
            echo "::error::PROJECT_A_ID secret is not set"
            exit 1
          fi
          if [ -z "$PROJECT_B_TOKEN" ]; then
            echo "::error::PROJECT_B_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$PROJECT_B_ID" ]; then
            echo "::error::PROJECT_B_ID secret is not set"
            exit 1
          fi
          if [ -z "$NEW_DOMAIN" ]; then
            echo "::error::NEW_DOMAIN secret is not set"
            exit 1
          fi
          if [ -z "$ENV_VAR_KEY" ]; then
            echo "::error::ENV_VAR_KEY secret is not set"
            exit 1
          fi
          
          # Run the bot
          npm start

      - name: Summary
        if: success()
        run: |
          echo "## ✅ Domain Rotation Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## ❌ Domain Rotation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
